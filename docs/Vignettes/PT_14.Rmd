---
title: "Model14"
author: "Several authors"
date: "Created: 12-04-2024. Last modified: `r format(Sys.time(), '%d-%m-%Y.')`"
output:
  html_document:
    mathjax: "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
    highlight: pygments
    theme: flatly
    code_folding: show
    # df_print: paged
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    number_sections: true
    fig_caption: true
always_allow_html: true
---

```{r, eval = FALSE, echo = FALSE}
################################################################################
################################################################################
################################################################################
################################################################################
######### DO NOT FORGET TO CHANGE THE TITLE EVERY TIME YOU FIT A MODEL #########
################################################################################
################################################################################
################################################################################
################################################################################
```

```{r xaringanExtra-clipboard, echo = FALSE}
htmltools::tagList(
  xaringanExtra::use_clipboard(
    button_text = "<i class=\"fa-solid fa-clipboard\" style=\"color: #00008B\"></i>",
    success_text = "<i class=\"fa fa-check\" style=\"color: #90BE6D\"></i>",
    error_text = "<i class=\"fa fa-times-circle\" style=\"color: #F94144\"></i>"
  ),
  rmarkdown::html_dependency_font_awesome()
)
```


```{css, echo = FALSE}
body .main-container {
  max-width: 100% !important;
  width: 100% !important;
}
body {
  max-width: 100% !important;
}

body, td {
   font-size: 16px;
}
code.r{
  font-size: 14px;
}
pre {
  font-size: 14px
}
```


Let us set some global options for all code chunks in this document.


```{r}
knitr::opts_chunk$set(
  message = FALSE,    # Disable messages printed by R code chunks
  warning = FALSE,    # Disable warnings printed by R code chunks
  echo = TRUE,        # Show R code within code chunks in output
  include = TRUE,     # Include both R code and its results in output
  eval = TRUE,       # Evaluate R code chunks
  cache = FALSE,       # Enable caching of R code chunks for faster rendering
  fig.align = "center",
  out.width = "100%",
  retina = 2,
  error = TRUE,
  collapse = TRUE
)
rm(list = ls())
set.seed(1982)
```

# Preprocessing

Let us now load some required libraries.

```{r}
# Load required libraries

# inla.upgrade(testing = TRUE)
# remotes::install_github("inlabru-org/inlabru", ref = "devel")
# remotes::install_github("davidbolin/rspde", ref = "devel")
# remotes::install_github("davidbolin/metricgraph", ref = "devel")

library(INLA)
inla.setOption(num.threads = 7)
library(inlabru)
library(rSPDE)
library(MetricGraph)

library(plotly)
library(dplyr)

library(sf)

library(here)
```

Function `standarize()` below is later used to standardize the covariate `SpeedLimit`.

```{r}
standardize <- function(x) {return((x - mean(x)) / sd(x))}
```



-------------------

**To keep track of the changes, we provide summaries of every new created object. Those summaries can be accessed by pressing the Show buttons below**

------------------


We load the graph object `sf_graph` (which only contains weights) and the data (already graph-processed). 

```{r}
load(here("Graph_objects/graph_construction_25_04_2024partialtomtomwhichlonglatsf.RData"))
load(here("Data_files/data_day7142128_hour13_with_no_consecutive_zeros_partialtomtom_graph_25_04_2024_processed.RData"))
data_on_graph = data_on_graph %>% 
  dplyr::select(-datetime)
```

```{r}
sf_graph$get_edge_lengths() %>% head() %>% capture.output() %>% grep("^Units:", ., value = TRUE)
```


```{r, class.source = "fold-hide"}
summary(sf_graph)
summary(data_on_graph)
```

The following commands remove zero speed observations that are 1m away from the graph, and after that, they remove any speed observations that are 3m away from the graph.

```{r}
to_remove = data_on_graph %>%
  filter(speed == 0, .distance_to_graph > 0.001) 

data_on_graph = setdiff(data_on_graph, to_remove) %>% 
  filter(.distance_to_graph <= 0.003)
```


```{r, class.source = "fold-hide"}
summary(to_remove)
summary(data_on_graph)
```

We add data to the graph.

```{r}
sf_graph$add_observations(data = data_on_graph, 
                          group = "day", 
                          normalized = TRUE, 
                          clear_obs = TRUE)
```


```{r, class.source = "fold-hide"}
sf_graph$get_data()
summary(sf_graph)
```

We get the values of the weights at data locations. This essentially gives us covariates from the weights.

```{r}
sf_graph$edgeweight_to_data(data_loc = TRUE)
```


```{r, class.source = "fold-hide"}
sf_graph$get_data()
summary(sf_graph)
```

When running `sf_graph$edgeweight_to_data(data_loc = TRUE)`, some `NA` values are created (because the data is grouped). We remove them below. We also standardize the `SpeedLimit` covariate. 

```{r}
data = sf_graph$get_data() %>% 
  drop_na(-StreetName) %>% # this drops all rows with at least one NA value but without taking into account StreetName
  mutate(across(c("SpeedLimit"), ~standardize(.))) %>%
  dplyr::select(speed, SpeedLimit)
```


## Crossvalidation 1

```{r}
load(here("Models_output/distmatrixfixed.RData"))

points = data %>%
  as.data.frame() %>%
  st_as_sf(coords = c(".coord_x", ".coord_y"), crs = 4326) %>%
  mutate(., index = 1:nrow(.)) %>% 
  st_drop_geometry() %>%
  dplyr:::select(speed, .group, index) %>%
  mutate(.group = as.numeric(.group)) %>%
  group_by(.group) %>%
  mutate(indexingroup = seq_len(n())) %>%
  ungroup()
```

```{r, fig.height = 8}
speed_at_nearestobservation = rep(NA, nrow(points))
for (i in 1:length(speed_at_nearestobservation)) {
  rowi <- points[i,]
  vec <- distmatrixlist[[rowi$.group]][rowi$indexingroup,]
  min_pos_in_vec <- which(vec != 0)[which.min(vec[vec != 0])]
  speed_at_nearestobservation[i] <- filter(points, .group == rowi$.group, indexingroup == min_pos_in_vec)$speed
}
```

```{r}
MSE_nearest_neighbor = mean((speed_at_nearestobservation - points$speed)^2)
```



```{r}
save.image(here(paste0("Models_output/", rmarkdown::metadata$title, ".RData")))
```

